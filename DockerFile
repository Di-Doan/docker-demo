# Stage 1: Build Frontend
FROM node:18 as frontend-build

WORKDIR /apps

# Copy package.json and package-lock.json to install dependencies
COPY package*.json ./
RUN npm install

# Copy frontend source files
COPY frontend/ ./
RUN npm run build

# Stage 2: Build Backend
FROM node:18 as backend-build

WORKDIR /apps

# Copy package.json and package-lock.json to install dependencies
COPY package*.json ./
RUN npm install

# Copy backend source files
COPY backend/ ./
RUN npm run build

# Final Stage: Combine Backend and Frontend into one image
FROM node:18

WORKDIR /apps

# Copy the frontend build from frontend-build stage
COPY --from=frontend-build /apps/frontend/dist /apps/frontend/dist

# Copy the backend build from backend-build stage
COPY --from=backend-build /apps/backend/dist /apps/backend/dist

# Expose the ports for backend and frontend
EXPOSE 3000 5000

# Start both backend and frontend using npm and wait for them to start
CMD ["sh", "-c", "npm run start:backend & npm run start:frontend && wait"]
