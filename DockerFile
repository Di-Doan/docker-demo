# Stage 1: Build Frontend
FROM node:18 as frontend-build

WORKDIR /apps

COPY frontend/package*.json ./  # Copy only frontend's package.json
RUN npm install
COPY frontend/ ./               # Copy all frontend source files
RUN npm run build

# Stage 2: Build Backend
FROM node:18 as backend-build

WORKDIR /apps

COPY backend/package*.json ./  # Copy only backend's package.json
RUN npm install
COPY backend/ ./               # Copy all backend source files
RUN npm run build

# Final Stage: Combine Backend and Frontend into one image
FROM node:18

WORKDIR /apps

# Copy the frontend build from frontend-build stage
COPY --from=frontend-build /apps/dist /apps/frontend/dist

# Copy the backend build from backend-build stage
COPY --from=backend-build /apps/dist /apps/backend/dist

# Expose ports
EXPOSE 3000 5000

# Start both backend and frontend
CMD ["sh", "-c", "npm run start:backend & npm run start:frontend && wait"]
