# Stage 1: Build Frontend
FROM node:18 as frontend-build

WORKDIR /app/frontend

COPY frontend/package*.json ./
RUN npm install
COPY frontend/ .
RUN npm run build

# Stage 2: Build Backend
FROM node:18 as backend-build

WORKDIR /app/backend

COPY backend/package*.json ./
RUN npm install
COPY backend/ .
RUN npm run build

# Final Stage: Combine Backend and Frontend into one image
FROM node:18

WORKDIR /app

# Copy the frontend build from frontend-build stage
COPY --from=frontend-build /app/frontend/dist /app/frontend/dist

# Copy the backend build from backend-build stage
COPY --from=backend-build /app/backend/dist /app/backend/dist

# Expose the ports
EXPOSE 3000 5000

# Start both backend and frontend
CMD ["sh", "-c", "npm run start:backend & npm run start:frontend"]
